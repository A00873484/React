<!DOCTYPE html>
<html>
    <head>
        <title>Udacity Todos Goals</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
        <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
        <script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
    </head>
    <body>

        <div id="app"></div>

        <script type="text/javascript">
            function generateId(){
                return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36)
            }

            //App Code
            const ADD_TODO = 'ADD_TODO', REMOVE_TODO = 'REMOVE_TODO', TOGGLE_TODO = 'TOGGLE_TODO'
            const ADD_GOAL = 'ADD_GOAL', REMOVE_GOAL = 'REMOVE_GOAL'
            const RECEIVE_DATA = 'RECEIVE_DATA'

            function addTodoAction (todo) {
                return {
                type: ADD_TODO,
                todo,
                }
            }

            function removeTodoAction (id) {
                return {
                    type: REMOVE_TODO,
                    id,
                }
            }

            function toggleTodoAction (id) {
                return {
                    type: TOGGLE_TODO,
                    id,
                }
            }

            function addGoalAction (goal) {
                return {
                    type: ADD_GOAL,
                    goal,
                }
            }

            function removeGoalAction (id) {
                return {
                    type: REMOVE_GOAL,
                    id,
                }
            }

            function receiveDataAction (todos, goals) {
                return {
                    type: RECEIVE_DATA,
                    todos,
                    goals,
                }
            }

            function handleDeleteTodo (todo) {
                return (dispatch) => {
                    dispatch(removeTodoAction(todo.id))   
                    return API.deleteTodo(todo.id).catch(()=>{
                        dispatch(addTodoAction(todo))
                        alert('An error occurred. Try again')
                    })
                }
            }

            function handleToggleTodo (todo) {
                return (dispatch) => {
                    dispatch(toggleTodoAction(todo.id))
                    return API.saveTodoToggle(todo.id).catch(()=>{
                        dispatch(toggleTodoAction(todo.id))
                        alert('An error occurred. Try again')
                    })
                }
                
            }

            function handleAddTodo (value, reset) {
                return (dispatch) => {
                    return API.saveTodo(value).then((todo)=>{
                        dispatch(addTodoAction(todo))
                        reset()
                    }).catch(()=>{
                        alert('There was an error adding todo. Try Again.')
                    })
                }
            }

            function handleDeleteGoal (goal) {
                return (dispatch) => {
                    dispatch(removeGoalAction(goal.id))
                    return API.deleteTodo(goal.id).catch(()=>{
                        dispatch(addGoalAction(goal))
                        alert('An error occurred. Try again')
                    })
                }
            }

            function handleAddGoal (value, reset) {
                return (dispatch) => {
                    API.saveGoal(value).then((goal)=>{
                        dispatch(addGoalAction(goal))
                        reset()
                    }).catch(()=>{
                        alert("Error occured. Try again.")
                    })
                }
            }

            function handleReceiveData () {
                return (dispatch) => {
                    Promise.all([API.fetchGoals(), API.fetchTodos()]).then(([goals, todos])=>{
                        dispatch(receiveDataAction(todos, goals))
                    })
                }
            }

            function toDos(state = [], action){
                switch(action.type) {
                    case ADD_TODO :
                        return state.concat([action.todo])
                    case REMOVE_TODO :
                        return state.filter((todo)=>todo.id !== action.id)
                    case TOGGLE_TODO :
                        return state.map((todo)=>todo.id !== action.id ? todo : 
                            Object.assign({}, todo, { complete: !todo.complete }))
                    case RECEIVE_DATA :
                        return action.todos
                    default :
                        return state
                }
            }

            function goals (state = [], action) {
                switch(action.type) {
                    case ADD_GOAL :
                        return state.concat([action.goal])
                    case REMOVE_GOAL :
                        return state.filter((goal)=>goal.id !== action.id)
                    case RECEIVE_DATA :
                        return action.goals
                    default :
                        return state
                }
            }

            function loading (state = true, action) {
                switch(action.type){
                    case RECEIVE_DATA :
                        return false
                    default : 
                        return state
                }
            }

            const checker = (store) => (next) => (action) => {
                if (
                    action.type === ADD_TODO &&
                    action.todo.name.toLowerCase().includes('bitcoin')
                ) {
                    return alert("Nope. That's a bad idea.")
                }

                if (
                    action.type === ADD_GOAL &&
                    action.goal.name.toLowerCase().includes('bitcoin')
                ) {
                    return alert("Nope. That's a bad idea.")
                }

                return next(action)
            }

            const logger = (store) => (next) => (action) => {
                console.group(action.type)
                    console.log('The action: ', action)
                    const result = next(action)
                    console.log('The new state; ', store.getState())
                console.groupEnd()
                return result
            }
            
            const store = Redux.createStore(Redux.combineReducers({
                toDos,
                goals,
                loading,
            }), Redux.applyMiddleware(ReduxThunk.default, checker, logger))
            
        </script>
        <script type = 'text/babel'>
            function List (props){
                return (
                    <ul>
                        {
                            props.items.map((item)=>(
                                <li key={item.id}>
                                    <span 
                                        style={{textDecoration: item.complete ? 'line-through' : 'none'}} 
                                        onClick={() => props.clicked && props.clicked(item)}>{item.name}</span> 
                                    <button onClick={()=>props.delete(item)}>X</button>
                                </li>)
                            )
                        }
                    </ul>
                )
            }

            class Todos extends React.Component {
                addItem = (e) => {
                    e.preventDefault()
                    this.props.store.dispatch(handleAddTodo(this.input.value, ()=>{this.input.value = ""}))
                }

                toggle = (item) => {
                    this.props.store.dispatch(handleToggleTodo(item))
                }

                delete = (item) => {
                    this.props.store.dispatch(handleDeleteTodo(item))
                }

                render(){
                    return (
                        <div>
                             <h1>Todo List</h1>
                             <input
                                type='text'
                                placeholder='Add Todo'
                                ref={(input) => this.input = input}
                             />
                             <button onClick={this.addItem}>Add Todo</button>  
                             <List items={this.props.todos} clicked={this.toggle} delete={this.delete}/>
                        </div>
                    )
                }
            }

            class Goals extends React.Component {
                addItem = (e) => {
                    e.preventDefault()
                    this.props.store.dispatch(handleAddGoal(
                        this.input.value,
                        () => this.input.value = ""
                    ))
                }

                delete = (item) => {
                    this.props.store.dispatch(handleDeleteGoal(item))
                }

                render(){
                    return (
                        <div>
                             <h1>Goals</h1>
                             <input
                                type='text'
                                placeholder='Add Goal'
                                ref={(input) => this.input = input}
                             />
                             <button onClick={this.addItem}>Add Goal</button>  
                             <List items={this.props.goals} delete={this.delete}/> 
                        </div>
                    )
                }
            }
            
            class App extends React.Component {
                componentDidMount () {
                    const { store } = this.props
                    store.subscribe(() => this.forceUpdate())
                    store.dispatch(handleReceiveData())
                }
                render(){
                    const { store } = this.props
                    const { toDos, goals, loading } = store.getState()

                    if (loading === true){
                        return <h3>Loading</h3>
                    }

                    return (
                        <div>
                            <Todos store={ this.props.store } todos={toDos}/>
                            <Goals store={ this.props.store } goals={goals}/>    
                        </div>
                    )
                }
            }

            ReactDOM.render(
                <App store={store}/>,
                document.getElementById('app')

            )
        </script>

    </body>
</html>